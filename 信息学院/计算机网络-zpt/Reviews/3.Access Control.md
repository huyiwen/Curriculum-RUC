[TOC]
# 介质访问控制子层
使用广播的信道(一台主机发出信息, 所有主机都能“收”到)上, 如果有多个**站/主机**同时发出信息, 将会导致信息混在一起, 无法分辨, 因此, 如何控制广播信道上各个站对信道的访问权, 是一个重要的问题。介质访问控制(MAC)子层是数据链路层的一部分, 用来解决这个问题。

信道划分的实质就是使用各种技术或协议让广播信道变成[点对点信道](Term.md#点对点)
## 静态信道划分
最朴素的想法是用分时, 分频等方法将物理信道划分出多个子信道。
### 排队模型
要衡量每一种信道划分技术的优劣, 可以计算平均情况下报文在网络中的延时:
- 稳定状态下, 输入率=输出率, 存储在网络中的报文平均数为**报文的平均到达速率$\times$报文在网络中的延时**
$$\begin{aligned}
    N =& \lambda T\\
    N =& \frac{\rho}{1-\rho} = \frac{\frac{\lambda}{\mu C}}{1-(\frac{\lambda}{\mu C})} = \lambda T\\
    \implies T =& \frac{1}{\mu C - \lambda}
\end{aligned}$$
  - 信道数据到达速率为$\lambda\  \mathrm{frame/s}$
  - 帧长度平均值为$\frac{1}{\mu}\  \mathrm{bit/frame}$
  - 信道容量为$C\  \mathrm{bps}$
  - 平均延时为$T\  \mathrm{s}$

#### 频分多路FDM
当信道带宽大于单个信号所需带宽时, 可以把信道分成好几个子信道
- 无法动态适应站点数和通信量的变化
- 有$N$个用户时, 平均延时为队列模型延时的$N$倍, 即$$C' = \frac{C}{N}, \lambda' = \frac{\lambda}{N} \implies T' = N\times T$$
#### 时分多路TDM
- 每个用户拥有固定的信道传送时槽
- **时延同上**
##### 统计时分多路STDM
- 动态分配信道的时间槽
#### 波分多路WDM
相当于**光**的频分多路
#### 码分多路CDM
##### 码片
每个站分配一个二进制序列, 当站发送比特$1$是, 即发送该序列, 发送比特$0$时, 发送该序列的**反码**, 即将序列中$0\rightarrow 1,1\rightarrow 0$。
- **不同的站之间, 码片序列彼此正交, 即内积为0**
- 码片序列和自身的[规格化内积](Term.md#规格化内积)为$1$, 和反码规格化内积为$0$
##### 发送和还原
- 多个站向信道上发送数据, 直接将其发送的比特序列相加, 得到$S$
- 接收方要还原`A`站的比特序列, 只需要将$S$与`A`的码片序列做规格化内积即可得到原来发送的数据
## 动态介质访问控制
静态划分信道对资源的要求较高, 因此采用一些**协议**控制每个站的动作, 让所有信息能够成功发送, 基本想法是每个站争用信道的控制权, 拿到控制权的站发送自己数据, 如果遇到冲突, 则重新发送, 直到发送成功为止。这些协议又称为**争用型协议**。
### ALOHA协议
基本假设:
- 单一信道, 没有误码
- 帧长固定, 无限个用户, 按照泊松分布产生新帧
- 在一个 [帧时$t$](Term.md#帧时) 内**所有站**产生$k$帧的概率服从泊松分布, 有$$p_k = \frac{G^ke^{-G}}{k!}$$
  - $G$为网络负载, 即 $t$ 内所有站平均发送的帧数
  - 有$0\lt k \le 1$, **若$k\gt 1$则每个帧都会冲突**
#### 纯ALOHA
用户有数据要发送时, 直接发送进入信道, 监听是否产生冲突, 如果产生冲突, 则等待一段随机的时间
##### 冲突危险区
- 假定$t_0$时刻发送一帧$F$, 那么$t_0 - t\sim t_0 + t$之间发送的任何其他帧都会和当前帧$F$产生冲突, 因此冲突危险区为$\mathbf{2t}$, 其中$t$为一帧的传输时延
##### 信道效率
- 在整个冲突危险区$2t$内, 平均产生$2G$个帧, 因此泊松分布的$\lambda = 2G$, 即在$2t$内一个帧也不产生的概率为$p_0 = e^{-2G}$, 则有吞吐量$$S = G\cdot p_0 = G\cdot e^{-2G}$$
  当$G = 0.5$时取最大, 有$\mathbf{S_{max} \approx 0.184}$
#### 分槽ALOHA
纯ALOHA对信道的利用率很低, 这是因为各个站对时间是盲目的, 时隙ALOHA把各站的时间同步, 划分为等长的**时槽Slot**, 用户有数据要发送时, 只能在**时间槽开始的时刻**发送进入信道, 监听是否产生冲突, 如果产生冲突, 则等待下一个时间槽开始。
- **时隙(时间槽)的长度对应一帧的传输时间**
##### 冲突危险区
- 假设在$t_0$时刻发送一个帧, 则$t_0 - t\sim t$期间内产生的帧由于也会在$t_0$发送, 会产生冲突, 因此冲突危险区为$\mathbf{t}$
##### 信道效率
  - 在冲突危险区内没有其他帧发送的概率为$p_0 = e^{-G}$, 其中$G$为平均每个时隙产生的帧数(网络负载), 则有吞吐量
  $$S = Gp_0 = Ge^{-G}$$
  当$G=1$时$\mathbf{S_{max} \approx 0.368}$

### 载波侦听多路访问协议CSMA
ALOHA协议中各个站点发送数据前不知道信道的情况, 因此发生碰撞概率较高, 在发送前侦听信道, 如果是空闲才发送, 这就是CSMA的基本思想。
#### 1-持续CSMA
- 站点有数据发送时, 先监听信道, 若信道空闲则直接发送, **若信道忙则继续监听直到发现信道空闲**, 若产生冲突, 则等待随机时间后重新开始发送过程
- 优点
  - 降低了信道空闲时间
- 缺点
  - 广播延迟越高, 协议效果越差
  - 多个站点同时在持续监听, 那么一旦信道空闲这些站同时发送数据, 还是会碰撞
#### 非持续CSMA
- 站点有数据发送时, 先监听信道, 若信道空闲则直接发送, **若信道忙则等待随机时间后重新开始发送过程**, 若产生冲突, 则等待随机时间后重新开始发送过程
- 优点
  - 降低了冲突概率
- 缺点
  - 增加了信道空闲时间
  - 增加了数据发送延迟
- **信道效率高于1-持续CSMA, 数据传输延迟高于1-持续CSMA**
#### p-持续CSMA
- **适用于分槽信道(分时间槽)**
- 站点有数据发送时, 先监听信道, **若信道空闲则以概率$p$直接发送, 以概率$1-p$等待下一个时间槽后发送, 若信道忙则等待下一个时间槽后重新开始发送过程**, 若产生冲突, 则等待随机时间后重新开始发送过程

#### 载波侦听多路访问/碰撞检测协议CSMA/CD
站点使用CSMA协议发送数据, 如果发现冲突, 则立刻停止发送, 并发出一个瞬间干扰信号(固定$48\mathrm{bit}$), 让所有站点都知道发生了冲突, 之后等待随机时间后重复上述过程
##### 重要特性
- 使用该协议的以太网不能进行全双工通信, 只能进行半双工通信
- 每个站在发送数据之后的一小段时间内, 可能发生碰撞
- 整个以太网的平均通信量远小于其最高数据率
##### 争用期/碰撞窗口
- 最先发送数据的站, 在发送数据帧后至多经过 $\mathbf{2T}$ 就可以知道发送的数据帧是否发生了碰撞, 其中$T$为**单向传播时延**
- **经过争用期也没有检测到碰撞, 那么就没有发生碰撞**
- 要保证在检测到冲突时站还没发完整个帧, 因此帧的**传输时延**必须大于$2T$:
  $$\frac{L}{B} \ge 2T$$
  - $L$为**最小帧长**
##### 冲突检测
- 信号电平法
  - 基于基带传输, 两个帧的信号叠加后, 电压大一倍
- 过零点检测法
  - 用曼彻斯特编码时, 零点在每比特的正中央, 有干扰时可能会偏移
- 自收自发检测法
  - 在发送数据的同时自己也接受数据, 逐个比特的进行比较
##### 二进制指数退避算法
站点知道冲突后, 立刻重发是不合适的, 因为会再次冲突。因此采用二进制指数退避算法控制站点重发冲突帧的时间。
- 确定基本退避时间$2T$
- 确定重传次数$k$, 保证$k\le 10$, 每次重传失败$k+=1, k=\min(10,k)$
- 从$\{0,1,2,\cdots,2^k-1\}$中选择则一个数$r$, $2rT$即为需要退避的时间
- 如果重传次数超过$16$则丢弃该帧, 向高层报告错误

#### CSMA/CA协议
在无线局域网中, 不能使用CSMA/CD, 因为要在无线信号中监听碰撞很难, 而且存在[隐蔽站和暴露站](Term.md#隐蔽站/暴露站)的问题。因此, 尽可能避免冲突。
- 任何一个站要发送数据前都要进入争用窗口, 随机退避(二进制指数退避)一段时间后发送。
##### 预约信道
发送方发送数据前告诉别的站自己传输数据所需的时间, 让别的站不要在这个时间段里发数据
##### 确认帧
接受方收到一个帧后向发送方返回一个`ACK帧`；如果发送方经过一段时间没有收到`ACK帧`则重发
##### RTS/CTS帧
- A向B发送`RTS(Request to Send)`帧, A周围的站点听到`RTS`, 在一段时间内不发送数据, 以确保A能正确收到B的回复(`CTS`)
- B收到`RTS`后回复`CTS(Clear to Send)`帧, B周围的站点听到`CTS`, 在一段时间内不发送数据, 以确保B能正确收到A的数据
- A收到`CTS`后开始发送数据, 如果冲突则随机等待一段时间
### 无冲突协议
#### 基本位图协议
- 假设共享信道上有$N$个站, 则单独划分一个**竞争周期**, 竞争周期分为$N$个时槽, 如果一个站有帧要发送, 则在对应的时槽内发送比特$1$, 这样在$N$个时槽后, 就会知道哪个站要发送帧, 这时按照站序号依次发送即可
- 属于**预订协议**
  - 在实际发送信息前西安广播发送请求的协议
- 效率
  - **轻负载下**每一轮竞争仅有部分站有帧要发送
    - 对于站$S[0]$, 其准备好数据帧后, 要等待$$\frac{N}{2}(上一轮结束) + N(这一轮) = \frac{3N}{2}$$才能发送数据
    - 对于站$S[-1]$, 其准备好数据帧后, 要等待$\frac{N}{2}$后才能开始发送数据
    - 因此平均情况每个站要等待$N$个时槽才能开始发送数据, 有$$\eta = \frac{d}{N+d}$$其中$d$为数据帧占用的帧时
  - **重负载下**由于每个站都有数据要发送, 因此等待$N$个时槽后会发送$Nd$个帧, 于是有$$\eta= \frac{d}{d+1}$$
- 缺点
  - 不平等(按照站序号进行发送)
  - 每个站都有一个比特的固定开销
#### 令牌传递协议
网络上有**一个**令牌, 只有拿到令牌的站才能发送数据
- 效率
   $$\eta = \frac{d}{d+\log_2{N}}$$

#### 有限竞争协议
- 轻负载下使用竞争, 重负载下使用无冲突, **将站分组, 组内竞争**
- 将站组织成二叉树, 第一个时间槽中所有节点都参与竞争, 如果冲突, 则下一个时间槽内左子树中的所有节点参与竞争, 如果还冲突, 左子树的左子树的所有节点参与竞争, 以此类推
- 系统负载越重, 越应该从靠近叶节点的子树开始搜索

## 局域网LAN
局域网(Local Area Network)是在一个较小的地理范围内将各种计算机, 外部设备通过物理介质相互连接起来组成资源和信息共享的计算机互联网络。
### 基本特点
- 是一种**广播信道**
  - 各个计算机站点是平等的
- 所有站点共享较高的数据传输率
- 时延低, 误码率低
- 距离短

一个局域网由三个要素标志:
#### 拓扑结构
- 星形
- 环形
- 总线型
- 树形
#### 传输介质
- 双绞线
- 光纤
- 无线
- 基带同轴
#### 介质访问控制
- CSMA/CD
  - 总线型局域网中使用
- 令牌总线
  - 总线型局域网中使用
- 令牌环
  - 环形局域网中使用
#### 最常见的局域网
- 以太网
  - 物理拓扑是星形结构, 逻辑上是总线形结构
- 令牌环802.5
  - 物理拓扑是星形结构, 逻辑上是环形结构
- FDDI(光纤分布数字接口802.8)

#### 802标准
在IEEE802标准中, 局域网的定义对应了物理层和数据链路层, 并且将数据链路层分为MAC子层和LCC子层
##### MAC子层
负责和物理链路交互, 提供组帧, 透明传输, 校验等功能
##### LLC子层
- 负责向网络层提供**无确认无连接, 面向连接, 有确认无连接, 高速传送**的四个服务。
- 并提供**给帧加序号, 差错控制等功能**
### 以太网802.3
IEEE802.3是一种**总线型局域网**的标准协议, 习惯称其为以太网。
- 以太网采用**无连接**的工作方式, 即不对发送的数据帧编号, 也不要求接收方返回确认帧
#### 传输介质
以太网常用的传输介质有粗缆, 细缆, 双绞线和光纤
#### 网卡
网卡又称为**通信适配器**或者**网络接口卡**, 是计算机、路由器等要联网的设备的组件。**它负责将计算机和传输介质相连**, 实现转换电信号, 组帧, 发帧, 介质访问控制, 数据编码等一系列功能。
##### MAC地址
每一个网卡在出厂时都会有一个**全球唯一的代码**, 称为介质访问控制(MAC)地址, 这个地址用于数据链路层设备之间的定位和通讯。
- MAC地址**长$6$字节**, 高$24$位为厂家代码, 低$24$位为厂家自行分配的序列号
#### 以太网的帧
- **前导码**
  - 在帧前插入8字节, 用于同步
- **目的MAC地址**
  - 6字节
- **源MAC地址**
  - 6字节
- **类型**
  - 2字节
  - 表名数据域的内容应该交给哪个协议处理
  - **或者表名整个帧的长度**
    - 如果这个域的值$s\le 1536$, 则表示长度
    - 如果这个域的值$1536<s\le 65535$, 则表示类型
- **FCS校验码**
  - 4字节, 即$32$位CRC码
  - 校验数据部分和地址、类型字段, 不校验前导码
- **数据**
  - 46~1500字节
  - 包装高层传来的整个数据单元(分组)
  - 由于帧有最小长度限制, 所以在没有数据时要进行填充, 使帧长达到$64$字节

#### 以太网性能
- 对每个站点来说, 从准备好帧到能够发送中间的等待时间越短越好；对整个信道来说, 在保证每个站点性能基础上能够支持的站点数越多越好
- 假设有$k$个站点参与竞争信道, 每个站点在每个[时隙](Glossary.md#帧时/时隙)中发送帧的概率为$p$
- 信道效率
  $$\begin{aligned}
    \eta &= \frac{T(发送一帧)}{T(发送一帧)+\overline{T(竞争)}}\\
    \overline{T(竞争)} &= \overline{N(竞争时隙数)} \times 2\tau
  \end{aligned}$$
  某个时隙内, 某个站点成功获取信道的概率为$A = kp(1-p)^{k-1}$, 因此某个站点竞争时隙数为$N = j$的概率为$B = A(1-A)^{j-1}$, 因此有$$\overline{N} = E(N) = \sum_{j = 1}^{\infin}j\times A(1-A)^{j-1} = \frac{1}{A} = \frac{1}{\lim_{k\rightarrow \infty}A} = e$$
  因此有$$\eta = \frac{T}{T + 2\tau e}$$
  - $T$为发送一帧的时间

## 无线局域网
### 802.11体系结构
#### 有架构
每个客户端和一个**接入点AP**相连, 并通过AP和其他网络相连；数个接入点可以通过**分布式系统**相连, 达成扩展。
#### 自组织
网络由一组相互关联的计算机组成, 他们之间可以相互发送帧, 没有接入点。
### 冲突避免
#### 分布式协调功能DCF
每个站管理自己的冲突等待时间, 使用**CSMA/CA协议**, **教材p248**
#### 点协调功能PCF
#### 信道侦听
- 物理侦听
  - 直接检查介质
- 虚拟侦听
  - 通过网络分配向量NAV, 在站内部保留一个信道何时要使用的记录, GIA信号不会发送
#### 802.11协议优化
- 增加帧成功传输概率
  - 发送短帧
  - 短帧即将帧拆分为更小的部分, 称为**段**
- 节省电源
  - 不用的时候休眠
- 服务质量
  - 建立不同帧之间的优先级, 即为不同的帧之间保留不同的时间间隔
  - **短帧间间隔SIFI**
    - 发送方发段(短帧)后只需要等待`SIFI`即可发送下一段
  - **仲裁帧间隔AIFS**
    - 有多种长度的AIFS
    - 短的AIFS用来发送语音
    - 长的AIFS用来发送背景流量等
  - **DIFS**
    - 常规数据帧之间的间隔
  - **EIFS**
    - 扩展帧之间的间隔
    - 常用于报告问题
### 802.11提供的服务
- 关联
  - 将客户端连接到AP
- 重新关联
  - 将客户端换一个AP
- 认证

### 宽带无线网
#### 802.16体系结构
- 物理层
  - 固定WiMAX OFDM
  - 移动WiMAX 可扩展OFDM
- 数据链路层
  - 安全子层
  - MAC公共子层
    - **面向连接**
    - 常数位速率服务
    - 实时可变位速率服务
    - 非实时可变位速率服务
    - 尽力投递服务
  - 特定服务汇聚子层
#### 帧结构
- 通用帧
- 带宽请求帧

### 蓝牙技术
#### 蓝牙体系结构
- 微网
  - 一个主节点, 7个活跃从节点, 255个驻留从节点
- 两个微网通过一个桥接从节点相连, 形成一个散网

- 物理层
  - 无线电
- 数据链路层
  - 蓝牙链路
    - 链路控制层
      - 类似于MAC子层, 将比特转化为帧
    - 链路管理协议
      - 建立逻辑信道
      - 同步有链接链路, 用于实时数据, 比如电话
      - 异步无连接链路, 用于交换数据, 尽力而为

## 广域网
覆盖范围很广的大范围网络, 但整个网络是相同的, 使用同样地协议。不同于局域网, 广域网协议涉及到网络层, 数据链路层和物理层。一般由节点**交换机**和其链路组成, 交换机负责在广域网内部转发分组。

广域网有两个著名的**数据链路层**协议:
### PPP协议
应用在直接连接两个节点的链路上, 用来建立点对点连接。其有2个组成部分:
- **链路控制协议LCP**
  - 用来建立配置管理数据链路
- **网络控制协议NCP**
  - 用来声明网络层使用的协议
#### 特点
- 只提供点到点, 不支持多点线路
- 只能检错, 不能纠错
- 仅支持全双工链路
- 连接的两端可以使用不同的网络层协议
- **面向字节**

### HDLC协议
- 面相比特


## 数据链路层的设备

### 网桥
是工作在**数据链路层**的设备, 基本功能是将两个或多个局域网连接在一起, 形成一个更大的局域网, 原来的每个局域网就称作一个**网段**。
- 连接在网桥同一个端口的站都属于同一个冲突域, 如果多个站连接在同一个端口, 则需要采用CSMA/CD协议
- 可以连接使用不同协议的局域网, 但可能会进行额外的帧格式转换
#### 和集线器的不同
- 使用集线器连接的网络都处在同一个冲突域, 不能隔离不同的局域网
- 集线器转发帧时不进行载波监听
- 网桥在转发帧之前必须执行CSMA/CD协议
#### 基本工作方式
- 收到`网络A`一个帧后, 检查MAC地址
- 如果目的地是`网络B`, 则将其转发到`网络B`；否则, 丢弃
- 因此需要维护一个哈希表, `站:能访问到站的端口`, 将每个目的和端口对应起来；网桥根据这个哈希表进行寻址转发, 不同的转发方法对应了不同类型的网桥:
##### 透明网桥
- 宏观来说, 透明网桥转发时不会使用**最佳路径**, 它通过如下算法更新自己的转发表:
  - 初始化哈希表为空
  - 假设站A通过端口1发送帧给站B, 站B连接在端口2上, 但网桥并不知道, 因此会将该帧转发到除1以外的所有端口上(**泛洪**), 并且更新哈希表, 将`A:1`添加进去, 因为网桥明白从1端口可以访问到A站
  - 重复上述, 则可以慢慢建立整个哈希表
  - 为了避免转发帧在链路上转圈, 设计了**生成树算法**, 即按照生成树进行转发, 确保每个源到每个目的地仅有一条路径, 但是, 这个路径不一定是最好的(时延最短)
  - 网桥的移动, 重启等会改变其拓扑结构, 因此网桥构造的哈希表中还存储了发送帧对应的时间, 即`A:1,TIME`, `TIME`代表网桥最后一次看到A发送帧的时间, 网桥会定期扫描整个哈希表, 将几分钟前的表项全部清除
###### 构造生成树 ppt p178
- 每个网桥广播自己的编号, 号最小的作为生成树的根
- 每个网桥计算自己到跟的最短路径, 构造生成树, 使得每个LAN和网桥到根的路径最短
- 如果端口不在生成树上, 关闭该端口的转发功能
- 当LAN发生故障时, 要重新计算生成树
- 一旦发现拓扑结构变化, 则更新生成树
##### 原路由网桥
- 按照最佳路径转发分组
- 源站广播一个发现帧, 每个接收站原路返回确认, 然后源站选择最优线路
#### 应用
- 将负载很重的LAN通过分隔成使用网桥互联的几个LAN以减轻负担
- LAN上如果有距离超过2500m的两台机器, 则需要使用网桥将LAN分隔成两个, 保证正常工作
- 网桥可以互联不同类型的LAN
- 网桥可以隔离负载, 防止出故障的站点损害全网
- 网桥有助于安全保密

### 以太网交换机/二层交换机
- **实质上就是一个多端口的网桥**
- 由于在数据链路层工作, 因此称为二层交换机
#### 特点
- 每个电缆有自己独立的冲突域
- [全双工](Glossary.md#工)通信
- 没有冲突
- 很容易发现故障
- 若一个端口的带宽为$B$, 有$N$个用户, 则交换机总容量为$\frac{NB}{2}$
#### 注意
- **物理层设备不能隔离冲突域, 也不能隔离广播域**
- **数据链路层设备只能隔离冲突域, 不能隔离广播域**
- **网络层设备既可以隔离冲突域, 又可以隔离广播域**
- 一般来说, 一个局域网构成一个广播域, 一个网段构成一个冲突域