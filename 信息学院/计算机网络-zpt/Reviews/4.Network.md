[TOC]
# 网络层
在实际的生活中, 使用不同协议的局域网, 广域网十分常见, 需要一个统一的办法让这些异构的网络互联起来, 这就是网络层的目的。物理层使用中继器让两个计算机相连, 数据链路层使用网关和交换机让两个局域网相连, 网络层则使用路由器。
## 互联网
将异构的网络连接形成的大网络。
## 路由
一般来讲, A向B发送分组, 先检查B和A是否在同一个网络上；如果是, 则**直接交付**；否则, 则通过路由器进行分组转发, 称为**间接交付**。
- 路由器完成两个最重要的功能:
  - **路由选择**
    - 构造路由表, 选择路径
  - **分组转发**
    - 当分组到达时使用怎么做
- **使用路由器相连的两个网络, 物理层, 数据链路层, 网络层协议都可以不同, 但是传输层、应用层协议必须相同**
### 拥塞
除了路由选择和分组转发之外, 通信子网上会因为出现过量的分组让路由器缓冲区溢出, 导致网络性能下降, 即**拥塞**；需要注意的是, **拥塞是整个网络的问题, 涉及网络中所有主机、路由器等因素。** 常见导致拥塞的原因有:
- 路由器内存
  - 队列溢出
- 网络瓶颈
  - 线路带宽低
  - 路由器效率低
#### 开环控制
在网络开始运行前就做出一些规定, 以防止拥塞发生, 一旦网络启动运行, 就不再更改
- 什么时候接受新的数据包
- 什么时候丢弃分组
  - 丢弃哪些分组
- 制定网络中各个几点的调度策略

#### 闭环控制
- 监视系统, 检测何时何地发生拥塞
  - **如果随着负载的上升, 系统吞吐量反倒降低, 则肯定发生了拥塞**
- 将拥塞信息传送到可能采取行动的地方
- 基于反馈, 调整系统

#### 路由算法改进
考虑负载变化
- 多路径路由
- 流量缓慢迁移

#### 准入控制
- 许可控制
  - 拥塞后不再建立任何虚电路
- 变通
  - 新建虚电路绕过有问题的区域
  - 在删除拥塞后的网络上建立虚电路
- 资源预留
  - 在建立虚电路时, 预留一些资源
- 流量特性
  - 漏桶和令牌桶
##### 漏桶机制
- 漏桶相当于缓冲区, 将用户发出的不平滑的数据分组流转变成网络中平滑的数据分组流
- 漏桶容量为$C\mathrm{bit}$, 路由器的输出速率为$\rho\mathrm{bit}$, 突发速率为$r\mathrm{bit}$, 则允许突发时间(桶被装满的时间)为$$T = \frac{C}{r-\rho}$$

##### 令牌桶机制
- 漏桶存放“令牌”, 每$\Delta T$产生一个令牌, 令牌累积到漏桶上界后就不在增加, 分组传送一个数据前必须获得一个令牌, 传输完成后删除该令牌
- 令牌桶容量为$C\mathrm{bit}$, 令牌产生速率为$\rho\mathrm{bit/s}$, 突发速率为$r\mathrm{bit}$, 则允许突发时间(桶被装满的时间)为$$T = \frac{C}{r-\rho}$$

#### 分组调度
如何将缓冲区中的分组发送到线路上
- 公平队列
  - 路由器的每个输出线路有多个队列, 循环扫描每一个队列, 发送队头
- 改进公平队列
  - 计算队列中每一个分组的完成时间, 先发先完成的, 支持后来先发, 见书p333
- 再改进公平队列
  - 加权, 某个队列的带宽是别人的两倍

#### 资源预留协议RSVP
- 在数据包沿途的路由器上预留一定的资源, 包括带宽, 缓冲区, 表空间
- 可扩展性差
#### 区分服务
- 一组路由器形成一个管理域, 某一客户登录到域中时, 必须携带某一服务类型字段, 用来标识所需的服务类别


### 路由算法
路由器进行路由选择时根据路由表, 路由表由路由算法进行计算, 常见的路由算法有:
#### 静态路由算法
- 提前计算好的, 在网络启动时就加在到路由上, 不可变
- 简单可靠, 但是一旦网络变动就很麻烦
##### 最短路径算法
人工计算两个主机之间的最短路径, 然后写入路由器的路由表里
#### 动态路由算法
- 自适应计算路由表, 增加了网络的负担
- 常见的动态路由算法有:
##### 泛洪算法
- 向所有线路(除了来源)转发
- 会产生大量重复分组, 实际很少采用
##### 距离矢量算法
- 每个路由维护一张表, **key为每一个目的路由, value为已知的最佳距离和线路**
- 通过和相邻路由交换信息来更新表, 即每隔一段时间**每个路由向自己的每个邻居发送自己的表, 并接受邻居的信息**
- 假设路由$A$的邻居$B$的表中有$C:d_1$, 且$A$自己的表里有$C:d_2, B:d_3$, 如果$d_1+d_3 < d_2$, 则更新$A$的路由表$C:d_1+d_3$
- **无穷计算问题**
  - 一个路由$A$坏掉, 它的邻居的邻居的路由表中到$A$的距离不会立刻改变, 造成反复迭代计算
##### 水平分裂算法
- 距离矢量算法的改进版, 对于路由$A$和其邻居$B$, 以及$B$的邻居路由$C$, 如果$C$不能直达$A$, 则在交换信息时, $C$永远告诉$B$它到达$A$的距离是$\infty$
- 同样存在无穷计算问题
##### 链路状态路由
每个节点**广播和其直接相连的链路状态**, 并通过接收到的信息**维护一个网络拓扑图,** 计算**任意节点对的最佳路径**, 以此更新路由表
- **发现邻居节点**
  - 发送`Hello`分组
- **设置链路成本**
  - 到某一个邻居的成本与这条链路带宽成反比
    - $1G=1, 100M=10$
  - 如果路由器地理位置很分散, 则取链路延迟作为成本
    - $往返时间/2$
- **构造链路状态分组**
  - 标识符: 发送方ID
  - 序号
    - 每次发送递增
  - 年龄
    - 每秒年龄减一, 减到0则丢弃该分组
  - 邻居列表
    - 邻居ID
    - 发送方到该邻居的成本
- **分发链路状态分组**
  - [泛洪](#泛洪算法)
  - 如果收到的分组的序号小于当前cache的序号, 则丢弃, 否则分发
  - 为了防止错误的或过时的分组一直在网络中传递, 给每个分组设定年龄
  - 扩散法改进
    - 多个路由发送了相同的数据分组给$A$
    - $A$需要给这些路由都返回ACK
  - **ppt57**
    - 发送标志: 源向值为1的目的地发送分组
    - ACK标志: 当前路由从值为1的路由接收了这个分组
- **计算新路由**
  - 路由器积累全部链路状态分组
    - 如果网络上有$n$个路由, 则共$2n$个链路状态分组
  - 构造网络拓扑图
  - Dijkstra算法求最短通路
  - 更新路由表

## IP协议
### IPv4
#### 分组格式
- 首部
  - **固定长度部分**
    - **20字节**
    - **版本**
      - 4bit
      - ip协议的版本
    - **首部长度**
      - 4bit
      - 以$32$字节为单位, 值为$5\sim 15$, 规定整个首部长度最大为$60$字节
    - **区分服务**
      - 8bit
      - 要求的不同的服务类型
    - **总长**
      - 16bit
      - 单位为**字节**, 规定分组的最大长度为$64K$字节($2^{16}$)
    - **标识**
      - 16bit
      - 分组“序号”, 本质是一个计时器, 每产生一个新分组, 标识加一；用于将分片的分组组装回去
    - **标志位**
      - 3bit
        - 最高位空
        - 次高位为$0$代表允许分段, 为$1$代表不允许分段
        - 最低位为$1$代表还有分段, 为$0$代表这是最后一个分段
    - **分段偏移**
      - 13bit
      - 单位为$8$字节, 因此段长须为$8$的倍数
      - 表名该分段在原分组的数据段中的位置, 最多分$8192$段
    - **首部校验和**
      - 16bit
      - **只检验数据报的首部**, 不用CRC
      - 发送端
        - 所有首部的字段都写为16bit, 校验和本身写为16个0, 然后相加
        - 得到的结果取反码, 得到校验和
      - 接收端
        - 所有首部的字段都写为16bit, 相加
        - 如果结果为全$1$, 则接受；否则丢弃
    - **生存期**
      - 8bit
      - 分组在网络中的寿命
      - 分组每经过一个路由器, 生存期减$1$, 减到$0$则丢弃分组
    - **协议**
      - 8bit
      - 指出分组的数据使用什么协议, $6$代表TCP, $17$代表UDP
    - **原地址**
      - 4字节
    - **目的地址**
      - 4字节
  - **可变长度部分**
    - 长度可变
    - 提供拓展途径
- 数据
##### 分片
将IP分组封装到数据链路层的帧中, 要求该帧的大小不超过数据链路层协议的最大传输单元MTU, 那么对于一些大的分组, 就需要将其分装在多个较小的IP分组中, 称为**片**
- **分片在目的主机才会被重组**
- **路径MTU发现**
  - 避免拆分数据包的方法
  - 多次尝试发送不同大小的数据分组直到符合要求
#### 转发分组
从数据报提取出目的主机IP地址$D$, 其所在网络$N$
1. 如果$N$与当前路由器直接相连, 那么将数据包直接交给$D$, 否则2
2. 如果路由表中有目的地为$D$的特定路由, 那么按照这个路由进行转发, 否则3
3. 如果路由表中有到达网络$N$的路由, 那么按照这个路由进行转发, 否则4
4. 如果路由表有一个默认路由, 那么按照默认路由进行转发, 否则5
5. 报告转发出错
#### IP地址
将整个因特网看成一个单一的网络, IP地址就是给每个连接在因特网的主机(路由器)分配一个在**全世界范围内**唯一的32bit的标识符
 $$网络号(前缀长度L位) + 主机号(32-L位)$$
- **主机号全为$0$, 则为网络地址, 不能用来分配给某个主机**
- **主机号全为$1$, 则为广播地址**
##### 子网掩码
- 由于$L$无法推测, 需要一个额外的数描述, 称为**子网掩码**
  - 比如$L=16$, 则写作$/16$
  - 也可以写作二进制格式, 并和IP地址做AND操作, 比如子网掩码为$255.255.255.0$, 代表$L=24$

##### 分级的地址结构
- 优点
  - IP地址管理机构只分配IP地址网络号, 主机号则由各单位自行分配
  - 路由器仅根据网络号转发分组, 让路由表项减少
- 当一个主机同时连接到两个网络上时, 则其拥有两个不同的网络号
  - 一个路由器至少拥有两个网络号
- **用集线器/网桥连接起来的若干局域网仍为一个网络, 因此这些局域网都具有同样的网络号**

##### 特殊的IP地址
- `0.0.0.0`: 本机
- `255.255.255.255`: 局域网中广播
- `127.x.y.z`: 回路
- 私有地址
  - `10.0.0.0 ~ 10.255.255.255`
  - `172.16.0.0 ~ 172.31.255.255`
  - `192.168.0.0 ~ 192.168.255.255`

##### 分类的IP地址
分为5类
- A类地址8位为网络号, 其中最高位为$0$, 即最多有$2^7 - 1 - 1 = 126$个网络号, 其余$2^{24} - 2$全是主机号
  - $\mathbf{1.0.0.0\sim 126.255.255.255}$
- B类地址16位为网络号, 其中最高两位为$10$, 即最多有$2^{14}=16384$个网络号, 其余$2^{16} -2$全是主机号
  - $\mathbf{128.0.0.0\sim 191.255.255.255}$
- C类地址24位网络号, 其中最高三位为$110$, 即最多有$2^{21}=2097152$个网络号, 其余$2^{8}-2$全是主机号
  - $\mathbf{192.0.0.0\sim 223.255.255.255}$
- D类地址用来组播, 其中最高四位为$1110$
  - $\mathbf{224.0.0.0\sim 239.255.255.255}$
- E类地址保留

#### 子网
在网络内部可以建立子网, IP地址变为:$$网络号+子网号+主机号$$

##### 路由器寻址
- 将目标ip地址和子网掩码做**与**, 然后对比结果和目标ip的前缀地址(网络号+子网号), 如果相符, 则发送
- 例子见书p356

#### 无分类域间路由选择CIDR
为了更有效地利用IPv4的地址结构, 并消除A,B,C的分类, 将网络号, 子网号合并为**网络前缀**, 即ip地址转为$$网络前缀+主机号$$

##### 路由聚合与最长前缀匹配
- 多个网络前缀相同的IP地址被聚合在一个网络前缀更短的地址下
- 路由器寻址时, 有可能对某一个ip地址得到多个匹配, 那么优先选择**具有最长网络前缀的路由**, 这称为**最长前缀匹配**
- 例子见ppt5 p189

#### NAT地址转换协议
将私有IP地址转化为公网上的IP地址(全球地址), 以缓解IP地址短缺并保护内网
- 多个私有地址可以对应同一个全球地址
- NAT维护一个 $公网IP:端口\rightarrow 内网IP:端口$ 的NAT转换表, 每一个传入NAT路由器的分组都会根据该表改变其源IP地址和目的IP地址
- 在接受互联网传回的数据时, 同样会在NAT表中查找对应端口, 然后返回给正确的机器

### IPv6
为了解决IPv4地址短缺的问题, IPv6被提出
#### 目标
- 更多的主机
- 更小的路由表
- 更快的路由器处理速度
- 更加安全
#### 改进
- IPv4的头部有13字段, IPv6仅需7个, 必需字段变为选填字段, 提高效率；并且**固定首部长度**
  - 区分服务
  - 流标签
  - 竞合长度
  - 下一个头
  - 条数限制
  - **源地址**
    - **16字节**
  - **目的地址**
    - **16字节**
- 不支持路由器分片, 只能由源逐级进行分片
### 配套协议
要让IP协议正常工作, 必须有一系列协议配合它:
#### 地址解析协议ARP
无论网络层使用什么协议, 最终数据在链路上传输时使用的永远是硬件地址(MAC地址), 因此需要完成从IP地址到MAC地址的转换, ARP提供了这个功能, 它是一个**网络层协议**。

**需要注意的是, ARP仅解决的是同一个局域网下IP地址到MAC地址的转换, 如果目的主机和源主机不在同一个LAN, 那么源主机需要通过ARP找到路由器的MAC地址然后将数据报发送给路由器**
- 每一个主机都有一个ARP cache, **其中包含所在局域网上各主机和路由器的IP地址到MAC地址的映射表**
- 当主机A向本局域网的主机B发送IP分组时, 现在ARP cache中查询是否有B的IP地址对应的键
  - 如果有, 就取出其值, 写入MAC帧后发送的数据链路
  - 如果没有, 源主机就向LAN中**广播**请求信息, 收到请求信息的每个主机发送包含自己的`IP:MAC地址`映射的响应帧, 来告知源主机自身的地址
##### 逆地址解析协议RARP
- 将MAC地址映射回IP地址
#### 动态主机配置协议DHCP
主机如何知道自己的IP地址？DHCP协议为主机动态地分配IP地址, 是一个**应用层协议**
  - 需要IP地址的主机向自己所处的LAN上**广播**`DHCP DISCOVER`包, 用来请求获取一个IP地址
  - 这个包到达DHCP服务器, DHCP服务器通过`DHCP OFFER`包给该主机分配一个IP地址

#### 多协议标签交换MPLS
- 在每个数据包前增加一个标签, 路由器根据标签而不是目标地址进行转发
- 标签的索引存在内部表中, 只需要查表就可以转发
- 位于数据链路层和网络层之间, 因此数据头的位置处于$$数据链路头|标签|网络头$$
- 标签只具有本地意义, 这意味着每一跳都需要对标签重新映射
- 可以把不同去向的多个流赋予同一个标签, 然后统一对待, 提供了更高的聚合能力

#### 因特网控制报文协议ICMP
IP是一个尽可能交付的数据报协议, 是没有编号的, 这使得管理网络层(流量控制等)功能很难实行, 因此ICMP允许目标主机或者中间经过的路由器向源主机返回特殊的IP分组, 用来报告出错、拥塞、丢包等信息。这是一个**传输层协议**
#### 因特网组管理协议AGMP


## 自治系统
因特网将整个互联网划分成很多比较小的**自治系统**, 一个自治系统内部可能由**多个局域网**。因此有两种通信方式: 自治系统内部的通信和自治系统间的通信, 分别使用了不同的协议:
#### 内部网关协议IGP
自治系统内部的路由选择协议
##### RIP协议
通过**距离矢量算法**从邻居节点接受RIP包, 更新路由表
- 最短路径长度小于$16$
- 将不可达路由器的距离设置为$16$
- 是一个**应用层协议**, 使用UDP传送数据

##### OSPF协议
通过**链路状态路由**获得全局的网络拓扑, 然后Djikstra计算和每个端点之间的最短路径, 根据最短路径进行转发
- 如果A和B之间有多条相同距离的最短路径, 则将这些最短路径都记住, 之后遇到A->B的报文时, 将数据均分在这些路径上(**负载均衡**)
- 只有当链路状态发生变化时, 相关路由器才会使用**泛洪**向所有路由器发送信息
- 是一个**网络层协议**, 直接使用IP分组封装数据
#### 外部网关协议BGP
自治系统间的路由选择协议
- 需要考虑的因素很复杂, 除了距离、带宽等网络因素外, 还有政治、商业因素等
- 难以使用最佳路由进行转发, 只求找到一个还可以的, 即不转圈的路径
- 是一个**应用层协议**, 使用TCP发送数据
#### 分层路由
同时, 为了减小每一个路由器要保存的路由表, 内部网关协议还将自治系统更细地划分为若干区域:
- 分层: 域, 簇, 区, 组
- $N$个路由器, 最优情况分$\ln N$层, 每个路由器表项数为$e\ln N$
- 每个自治系统有一个主干区域, 所有区域都与主干区域相连
- 三种路由
  - 区域内
  - 区域间
    - 从源路由器到主干路由器
    - 穿越主干区域到达目的路由器
  - 自治系统之间

## x播
### 单播
点对点传送分组, 即一个分组仅会到达一个目的端点, 常见的应用是TCP
### 组播
使一个数据分组到达一组目的端点, 常见的应用是UDP
- 主机可以使用特定的协议加入组和退出组
#### IP组播
- 并非所有D类地址都能用来组播, 本地组播地址
  - `224.0.0.1`
  - `224.0.0.2`
  - `224.0.0.5`
  - `224.0.0.251`
- 通过构建**生成树**, 将某些节点划分到某个组, 一个节点可以同时存在两个组内
  - 核心树
    - 位于整个组的生成树的核心位置, 所有要发给组内成员的数据都要先发给核心树
##### IGMP协议
- 当主机加入组播组时, 该主机向组播路由器发送IGMP分组
- 组播路由器定期检查组内各个主机是否还在组中

### 广播
向局域网上所有主机发送数据
### 任播
- **IPv6引入**
- 将数据包转发给**最近的一个组成员**
- 使用普通的距离矢量路由或者链路状态路由

## 网关
宏观上只将两个网络连接起来的设备, 在网络层, 网关就是**路由器**
### 默认网关
默认网关即为**默认路由器**, 当ARP请求没有返回正确的物理地址时, 则会将数据分组转发到默认网关上