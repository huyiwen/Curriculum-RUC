# 数据库恢复
## 事务
- 恢复和并发的基本单位
- **ACID**
  - 原子性
    - 事务中的操作要么都做, 要么都不做
  - 一致性
    - 事务的执行结果让数据库从一个一致状态转移到另一个一致状态
  - 隔离性
    - 事务之间彼此互不干扰
  - 持续性
    - 事务一旦提交, 其对数据库的改变就是永久性的
### 事务的正常结束
- `COMMIT`
  - 提交更改
  - 写入缓存区, 可能不会及时写会存储区
- `ROLLBACK`
  - 撤销所有更改
## 故障
### 事物内部的故障
- 很大一部分不能由应用程序处理
- 全部撤销
### 系统故障
- `CPU`故障等系统级别出错, 不破坏数据库, 但让所有事务非正常终止
- **撤销所有未完成事务**
- **重做已经`COMMIT`的事务**
### 介质故障
- 破坏数据库
- 需要进行数据**转储**
## 转储
### 静态转储
- 转储期间不允许任何数据库操作
### 动态转储
- 转储期间可以进行数据库操作, 用**日志**记录
- **将转储期间的日志文件和数据库副本结合才能得到数据库的一致性状态**
### 镜像
- 直接把数据库所有数据复制到镜像磁盘上, 这样即使发生介质故障, 也可以用镜像数据库给用户提供服务
## 日志
### 登记日志
- 次序严格按照各个事务执行的时间次序
- **先写日志文件, 后写数据库**
  - 对于只在日志中写了没在数据库里写的操作, 最后都会是`UNDO`
## 恢复
- 不需要用户干预
### 基本方法
**从上一个保存的数据库一致性状态开始,**
- 正向扫描日志文件
  - 找到故障前已经提交的事务, 将其加入重做队列
  - 找到故障前未完成的事务, 将其加入撤销队列
- 撤销
  - 反向扫描日志文件, 对该事务的每一个更新做逆操作
- 重做
### 检查点
#### 文件构成
- **检查点记录**
  - 建立检查点时刻所有正在执行的事务清单
  - 这些事务最近一个日志记录的地址
    - 只有保存了这个地址, 才能根据从上一个数据库一致性状态进行恢复
- **重新开始文件的内容**
  - 记录各个检查点记录在日志文件中的地址
#### 恢复
- 检查点保存某一时刻数据库的状态, 包括所有正在执行的事务
- **在检查点之前正常结束的事务已经写回数据库, 不需要管**
- **在检查点之后提交的事务需要重做**
- **在检查点之后回滚的事务需要撤销**
- **在检查点之后没有正常结束的事务需要撤销**
#### 维护
- 在每一个检查点维护一个`REDO list`和一个`UNDO list`
- 初始所有正在执行的事务都在`UNDO list`
- 如果一个事务提交了, 将其移至`REDO list`
- 如果新建事务, 将其添加至`UNDO list`