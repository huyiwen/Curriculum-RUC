[TOC]
# 输入输出
## 核心
- `CPU`和`I/O`速度不一致
- `CPU`和`I/O`争夺系统总线使用权
## 编址方式
- 统一编址
  - 存储器单元和`IO`端口在同一个地址空间的不同区域
- 独立编制
  - 存储器单元和`IO`端口在相互独立的地址空间

## `IO`控制方式
### 程序查询
- `CPU`一直查询外设, 等其工作结束

### 中断
#### 中断类型
- 软件中断
  - 由软件抛出, 比如`INT 3`
- 硬件中断
  - 内部中断
    - `CPU`异常引起
  - 外部中断
    - `CPU`连接的外设引脚抛出的终端请求
    - 可屏蔽中断
      - 可以被中断屏蔽寄存器的位屏蔽禁止
    - 非屏蔽中断
      - 不能屏蔽, `CPU`必须响应, 比如定时器
#### 中断的相关概念
- **中断禁止**
  - 通过将`CPU`内部的中断允许寄存器置$0$, 可以禁止相应来自中断线的请求
- **中断屏蔽**
  - 通过`CPU`内部的中断屏蔽寄存器 可以通过软件来禁止外部的中断
- **中断向量表**
  - 中断服务程序的入口地址
    - $中断类型号\times 4=中断向量首地址$
    - 从这个地址里去除两个字节, 即为**中断服务程序**的入口地址
    - 第一个字节是**段地址**, 第二个字节是偏移地址
  - $1K$的空间, 存储$256$个中断服务程序的入口
- **中断优先级**
  - 高级中断可以打断低级中断处理程序的运行
#### 中断判优
- 软件查询法
- 硬件排队方式
- 优先级编码集成芯片

#### 中断响应
- 保护现场
  - 保护状态寄存器, 保护断点(**将下一条指令存入堆栈**)
    - **响应中断时**
    - **硬件实现**
  - 保护寄存器中的值, 将**要修改的寄存器的内容**存入堆栈
    - **中断服务程序中**
    - **软件实现**
- 根据中断类型码

### DMA
- 每次中断都需要保护断点和现场, 很慢
- `DMA`工作时不需要`CPU`干预
#### 操作模式
- **阵发模式**
  - 一次传输一个完整的数据块
- **周期窃取模式**
  - `DMA`和`CPU`之间通过`BG(Bus Grant)`和`BR(Bus Request)`信号协调系统总线的使用权
  - `DMA`持续地发出`BR`, 每次得到`BG`后传输一个字节, 并将控制权通过`BG`传回给`CPU`
- **透明模式**
  - 通过硬件让`DMA`仅在`CPU`不工作时进行传输
- **`CPU`和`DMA`交替模式**
  - 当`CPU`工作周期**长于**主存访问时间(**I/O时间**)时使用
  - 将`CPU`周期划分为`C1`和`C2`两个周期
    - `C1`只给`CPU`使用
    - `C2`只给`DMA`使用

## 总线
- `CPU`与外部设备的连接线路
- 分为数据总线, 地址总线, 控制总线
- 外部设备通过相应的接口电路与总线相连
- 总线分为**系统总线**和**外部总线**
  - **系统总线**是`CPU`内部的总线
  - **外部总线**是连接各种外设的总线
### 带宽
$$B = f*w$$
- $f$为频率
- $w$为可以同时传输的数据宽度$bit$
### 工作原理
- 各个器件以高阻态连接在总线上
- 某一个器件向另一个器件发出信号, 占用总线
- 对应器件收到信号, 接受数据
- 发送信号的器件回到高阻态, 让出总线
### 仲裁
- 总线主设备: **`CPU`,`DMA`**
- 总线从设备: **存储器, 外设等**

#### 总线仲裁器
- 用硬件实现总线分配
- 分类
  - **集中式仲裁**
    - 链式查询
      - 一个设备一个设备挨着给予权限
    - 计数器定时查询
      - 没有设备占用总线时计数器的值一直加一
      - 计数器的值和某一外设的设备码相等时, 给这个外设给予权限
    - 独立请求
      - 每个设备两条线连到仲裁器上, 自己请求自己的
  - **分布式仲裁**
### 连接方式
#### 单总线结构
- 一条总线连接`CPU`,`I/O`和存储器
#### 双总线结构
- 在`CPU`和**存储器**之间设立存储总线, 方便传输数据, 降低总线压力
#### 三总线结构
- 在双总线的基础上增设`I/O`总线, 所有外设连接在`I/O`总线上